#!/bin/bash
#
# Git Post-Checkout Hook: Branch Context Manager
# è‡ªåŠ¨ä¿å­˜å’Œæ¢å¤åˆ†æ”¯ç‰¹å®šçš„ä¸Šä¸‹æ–‡æ–‡ä»¶ï¼ˆconstitution, AI memoryï¼‰
#
# å®‰è£…æ–¹æ³•:
#   cp post-checkout .git/hooks/
#   chmod +x .git/hooks/post-checkout
#
# æˆ–ä½¿ç”¨è‡ªå®šä¹‰ hooks ç›®å½•:
#   cp post-checkout .githooks/
#   git config core.hooksPath .githooks
#

# Hook å‚æ•°
PREV_HEAD="$1"   # å‰ä¸€ä¸ª HEAD
NEW_HEAD="$2"    # æ–° HEAD
CHECKOUT_TYPE="$3"  # 1=åˆ†æ”¯åˆ‡æ¢, 0=æ–‡ä»¶åˆ‡æ¢

# åªå¤„ç†åˆ†æ”¯åˆ‡æ¢ï¼ˆä¸å¤„ç†æ–‡ä»¶ checkoutï¼‰
if [ "$CHECKOUT_TYPE" != "1" ]; then
    exit 0
fi

# é…ç½®
CONTEXT_STORE=".git/branch-contexts"  # ä¸Šä¸‹æ–‡å­˜å‚¨ç›®å½•
CONTEXT_FILES=(
    "memory/constitution.md"
    "CLAUDE.md"
    "GEMINI.md"
    "COPILOT.md"
    "CURSOR.md"
)

# é¢œè‰²å®šä¹‰
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ========================================
# å·¥å…·å‡½æ•°
# ========================================

get_branch_name() {
    # ä» commit hash è·å–åˆ†æ”¯å
    local commit="$1"
    git name-rev --name-only "$commit" 2>/dev/null | sed 's/remotes\/origin\///'
}

get_current_branch() {
    git symbolic-ref --short HEAD 2>/dev/null
}

save_context() {
    local branch="$1"

    if [ -z "$branch" ] || [ "$branch" = "HEAD" ]; then
        return
    fi

    echo -e "${BLUE}ğŸ’¾ Saving context for: ${branch}${NC}"

    # åˆ›å»ºå­˜å‚¨ç›®å½•
    mkdir -p "$CONTEXT_STORE/$branch"

    local saved_count=0

    # ä¿å­˜æ¯ä¸ªä¸Šä¸‹æ–‡æ–‡ä»¶
    for file in "${CONTEXT_FILES[@]}"; do
        if [ -f "$file" ]; then
            cp "$file" "$CONTEXT_STORE/$branch/$file"
            echo -e "${GREEN}   âœ… Saved $file${NC}"
            ((saved_count++))
        fi
    done

    # ä¿å­˜å…ƒæ•°æ®
    cat > "$CONTEXT_STORE/$branch/metadata.json" <<EOF
{
  "branch": "$branch",
  "saved_at": "$(date -Iseconds)",
  "commit": "$(git rev-parse HEAD)",
  "saved_by": "$(git config user.name)",
  "files_saved": $saved_count
}
EOF

    if [ $saved_count -gt 0 ]; then
        echo -e "${GREEN}   âœ… Saved $saved_count context file(s)${NC}"
    fi
}

restore_context() {
    local branch="$1"

    if [ -z "$branch" ] || [ "$branch" = "HEAD" ]; then
        return
    fi

    if [ ! -d "$CONTEXT_STORE/$branch" ]; then
        echo -e "${YELLOW}âš ï¸  No saved context for: ${branch}${NC}"
        echo -e "${YELLOW}   Using files from Git${NC}"
        return
    fi

    echo -e "${BLUE}ğŸ“‚ Restoring context for: ${branch}${NC}"

    local restored_count=0

    # æ¢å¤æ¯ä¸ªä¸Šä¸‹æ–‡æ–‡ä»¶
    for file in "${CONTEXT_FILES[@]}"; do
        if [ -f "$CONTEXT_STORE/$branch/$file" ]; then
            # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
            mkdir -p "$(dirname "$file")"

            cp "$CONTEXT_STORE/$branch/$file" "$file"
            echo -e "${GREEN}   âœ… Restored $file${NC}"
            ((restored_count++))
        fi
    done

    # æ˜¾ç¤ºå…ƒæ•°æ®
    if [ -f "$CONTEXT_STORE/$branch/metadata.json" ]; then
        local saved_at=$(jq -r '.saved_at' "$CONTEXT_STORE/$branch/metadata.json" 2>/dev/null || echo "unknown")
        echo -e "${GREEN}   ğŸ“… Context saved at: ${saved_at}${NC}"
    fi

    if [ $restored_count -gt 0 ]; then
        echo -e "${GREEN}   âœ… Restored $restored_count context file(s)${NC}"
    fi
}

display_summary() {
    local prev_branch="$1"
    local new_branch="$2"

    echo ""
    echo -e "${GREEN}âœ… Branch context switched successfully${NC}"
    echo -e "   Previous: ${YELLOW}${prev_branch}${NC} (saved)"
    echo -e "   Current:  ${GREEN}${new_branch}${NC} (restored)"
    echo ""
}

# ========================================
# ä¸»é€»è¾‘
# ========================================

main() {
    # è·å–åˆ†æ”¯å
    PREV_BRANCH=$(get_branch_name "$PREV_HEAD")
    NEW_BRANCH=$(get_current_branch)

    echo ""
    echo -e "${BLUE}ğŸ”„ Branch Context Manager: ${PREV_BRANCH} â†’ ${NEW_BRANCH}${NC}"
    echo ""

    # ä¿å­˜å‰ä¸€ä¸ªåˆ†æ”¯çš„ä¸Šä¸‹æ–‡
    if [ -n "$PREV_BRANCH" ] && [ "$PREV_BRANCH" != "HEAD" ]; then
        save_context "$PREV_BRANCH"
        echo ""
    fi

    # æ¢å¤æ–°åˆ†æ”¯çš„ä¸Šä¸‹æ–‡
    if [ -n "$NEW_BRANCH" ]; then
        restore_context "$NEW_BRANCH"
        echo ""
    fi

    # æ˜¾ç¤ºæ‘˜è¦
    display_summary "$PREV_BRANCH" "$NEW_BRANCH"

    # å¯é€‰ï¼šé€šçŸ¥ AI Agent ä¸Šä¸‹æ–‡å·²æ›´æ–°
    # å¦‚æœæœ‰ SessionStart hookï¼Œå¯ä»¥åœ¨è¿™é‡Œè§¦å‘
    if [ -f ".claude/hooks/on_context_restored.sh" ]; then
        bash .claude/hooks/on_context_restored.sh "$NEW_BRANCH" &
    fi
}

# æ‰§è¡Œä¸»å‡½æ•°
main

exit 0
